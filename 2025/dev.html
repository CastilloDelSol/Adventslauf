<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Teilnehmer Hexagon-Heatmap – Ratzeburger Adventslauf 2025</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js"></script>

<style>
html, body, #map { height:100%; margin:0; padding:0; }
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
               Roboto, Helvetica, Arial, sans-serif;
}

/* ---------- Fade für Hexagon Layers ---------- */
.leaflet-pane.hex-pane {
  transition: opacity 0.45s cubic-bezier(.3,.02,.7,.98);
}

/* ---------- Fade für Tile Layers ---------- */
.leaflet-pane.tile-pane {
  transition: opacity 0.45s cubic-bezier(.3,.02,.7,.98);
}

/* ---------- Buttons, Stats, Legend etc. ---------- */
.right-buttons {
  position: absolute; top: 20px; right: 20px; z-index: 9902;
  display: flex; flex-direction: column; gap: 10px;
}
.map-button {
  background:white; padding:8px 14px; border-radius:6px; border:1px solid #999;
  cursor:pointer; font-size:14px; min-width:130px; text-align:center;
  box-shadow:0 2px 4px rgba(0,0,0,0.25);
}
.map-button:hover { background:#f0f0f0; }

.stats-box {
  position:absolute; bottom:90px; left:20px; background:white; padding:12px;
  border-radius:8px; font-size:13px; box-shadow:0 2px 6px rgba(0,0,0,0.25);
  max-width:260px; z-index:9903;
}
.legend {
  background:white; padding:10px; border-radius:6px;
  font-size:13px; box-shadow:0 2px 6px rgba(0,0,0,0.25);
}
.legend i {
  width:18px; height:18px; float:left; margin-right:8px; border-radius:3px;
}

</style>
</head>

<body>

<div id="map"></div>

<div class="right-buttons">
  <div id="btnMapType" class="map-button">CARTO Light Grey</div>
  <div id="btnRes" class="map-button">Feine Auflösung (r7)</div>
</div>

<div id="stats" class="stats-box">Lade Statistik…</div>

<script>
/* ============================================================
   LOAD BUCKETS FIRST
   ============================================================ */
let BUCKETS = [];

fetch("buckets.json")
  .then(r => r.json())
  .then(data => {
    BUCKETS = data.buckets;
    initMap();
  });


/* ============================================================
   INIT MAP
   ============================================================ */
function initMap() {

  const map = L.map("map", {
    preferCanvas: true,
    inertia: false,
    center: [53.699327, 10.774143],
    zoom: 9
  });

  /* ---------- Tile Panes ---------- */
  map.createPane("tilesOSM");
  map.getPane("tilesOSM").classList.add("tile-pane");
  map.createPane("tilesCARTO");
  map.getPane("tilesCARTO").classList.add("tile-pane");

  map.getPane("tilesOSM").style.zIndex = 200;
  map.getPane("tilesCARTO").style.zIndex = 201;

  map.getPane("tilesOSM").style.opacity = "1";
  map.getPane("tilesCARTO").style.opacity = "0";

  const osmTiles = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { maxZoom:19, pane:"tilesOSM" }
  ).addTo(map);

  const cartoTiles = L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
    { maxZoom:19, pane:"tilesCARTO" }
  ).addTo(map);

  let currentBase = "osm";


  /* ---------- Base Layer Fade Button ---------- */
  btnMapType.onclick = () => {
    if (currentBase === "osm") {
      map.getPane("tilesOSM").style.opacity = "0";
      map.getPane("tilesCARTO").style.opacity = "1";
      currentBase = "carto";
      btnMapType.textContent = "OSM Standard";
    } else {
      map.getPane("tilesOSM").style.opacity = "1";
      map.getPane("tilesCARTO").style.opacity = "0";
      currentBase = "osm";
      btnMapType.textContent = "CARTO Light Grey";
    }
  };


  /* ---------- Hexagon Panes ---------- */
  map.createPane("hex6");
  map.createPane("hex7");

  map.getPane("hex6").classList.add("hex-pane");
  map.getPane("hex7").classList.add("hex-pane");

  map.getPane("hex6").style.zIndex = 410;
  map.getPane("hex7").style.zIndex = 420;

  map.getPane("hex6").style.opacity = "1";
  map.getPane("hex7").style.opacity = "0";

  let currentResolution = "r6";


  /* ---------- Color helper ---------- */
  const getColor = idx => BUCKETS[idx].color;
  const getLabel = idx => BUCKETS[idx].label;


  /* ============================================================
     LOAD HEX LAYERS (r6 & r7)
     ============================================================ */
  let layer6 = null;
  let layer7 = null;

  function loadHex(file, pane, cb) {
    fetch(file)
      .then(r => r.json())
      .then(data => {
        const geo = L.geoJSON(data, {
          pane,
          style: f => ({
            fillColor: getColor(f.properties.count_index),
            color: "#6B6B6B",
            weight: 0.7,
            fillOpacity: 0.33
          }),
          onEachFeature: (f, layer) => {
            layer.bindTooltip(
              "Anmeldungen: " + getLabel(f.properties.count_index),
              { sticky: true }
            );
          }
        });
        cb(geo);
      });
  }

  loadHex("hexagons_r6.geojson", "hex6", geo => {
    layer6 = geo;
    layer6.addTo(map);
    map.getPane("hex6").style.pointerEvents = "auto";
  });

  loadHex("hexagons_r7.geojson", "hex7", geo => {
    layer7 = geo;
    layer7.addTo(map);
    map.getPane("hex7").style.pointerEvents = "none";
  });


  /* ============================================================
     RESOLUTION BUTTON WITH FADE + CORRECT TOOLTIP PANE
     ============================================================ */
  btnRes.onclick = () => {
    if (!layer6 || !layer7) return;

    if (currentResolution === "r6") {
      map.getPane("hex6").style.opacity = "0";
      map.getPane("hex7").style.opacity = "1";

      map.getPane("hex6").style.pointerEvents = "none";
      map.getPane("hex7").style.pointerEvents = "auto";

      currentResolution = "r7";
      btnRes.textContent = "Grobe Auflösung (r6)";
    } else {
      map.getPane("hex6").style.opacity = "1";
      map.getPane("hex7").style.opacity = "0";

      map.getPane("hex6").style.pointerEvents = "auto";
      map.getPane("hex7").style.pointerEvents = "none";

      currentResolution = "r6";
      btnRes.textContent = "Feine Auflösung (r7)";
    }
  };


  /* ============================================================
     LEGEND
     ============================================================ */
  const legend = L.control({ position:"bottomright" });

  legend.onAdd = () => {
    const div = L.DomUtil.create("div", "legend");
    div.innerHTML = "<b>Anmeldungen</b><br>";
    BUCKETS.forEach(b => {
      div.innerHTML += `<i style="background:${b.color}"></i>${b.label}<br>`;
    });
    return div;
  };
  legend.addTo(map);


  /* ============================================================
     STATISTICS BOX
     ============================================================ */
  fetch("statistics.json")
    .then(r => r.json())
    .then(s => {
      document.getElementById("stats").innerHTML = `
        <b>Statistiken</b>
        <table>
          <tr><td class="label">Anmeldungen:</td><td>${s.total_participants}</td></tr>
          <tr><td class="label">Min Distanz:</td><td>${s.distance_min_km} km</td></tr>
          <tr><td class="label">Max Distanz:</td><td>${s.distance_max_km} km</td></tr>
          <tr><td class="label">Ø Distanz:</td><td>${s.distance_avg_km} km</td></tr>
          <tr><td class="label">Median:</td><td>${s.distance_median_km} km</td></tr>
        </table>

        <br><b>Anreise-Entfernungen</b>
        <table>
          ${Object.entries(s.distance_buckets)
            .map(([k,v]) => `<tr><td class="label">${k}:</td><td>${v}</td></tr>`).join("")}
        </table>
      `;
    })
    .catch(() => {
      document.getElementById("stats").innerHTML = "Keine Statistikdaten gefunden.";
    });

} // END initMap()

</script>

</body>
</html>
