<script>
// --- formatter: Komma als Dezimaltrenner ---
function formatNumber(value) {
  return String(value).replace(".", ",");
}

document.addEventListener("DOMContentLoaded", () => {
  fetch("./statistics.json")
    .then(r => r.json())
    .then(buildDashboard)
    .catch(err => console.error("Could not load statistics.json", err));
});

function buildDashboard(data) {

  // ---- TOP BOX VALUES ----
  document.getElementById("totalParticipants").textContent = data.total_participants;
  document.getElementById("distanceMin").textContent = formatNumber(data.distance_min_km.toFixed(2));
  document.getElementById("distanceAvg").textContent = formatNumber(data.distance_avg_km.toFixed(2));
  document.getElementById("distanceMedian").textContent = formatNumber(data.distance_median_km.toFixed(2));
  document.getElementById("distanceMax").textContent = formatNumber(data.distance_max_km.toFixed(2));

  // ---- 1%-Perzentile ----
  const entries = Object.entries(data.percentiles_km)
    .sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]));

  const percentiles = entries.map(e => parseFloat(e[0])); // 0..100
  const distances = entries.map(e => e[1]);               // km

  // ----- X-axis tick labels: only 0,10,20,...100 -----
  const xTicks = [];
  const xTickLabels = [];
  for (let p = 0; p <= 100; p += 1) {
    xTicks.push(p);
    xTickLabels.push(p % 10 === 0 ? p + "%" : "");
  }

  // ----- Y-axis ticks (logarithmic, human) -----
  const yTicks = [0.1, 0.2, 0.5, 1, 2, 5, 10, 20, 50, 100, 200, 500, 1000, 2000];
  const yTickLabels = yTicks.map(v => formatNumber(v));

  // ----- TRACE -----
  const trace = {
    x: percentiles,
    y: distances,
    mode: "lines+markers",
    line: { color: "#0EA5E9", width: 3 },
    marker: { color: "#0EA5E9", size: 5 }
  };

  // ----- LAYOUT -----
  const layout = {
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)",
    margin: { t: 15, r: 20, b: 60, l: 75 },

    xaxis: {
      title: "Perzentil [%]",
      range: [0, 100],
      tickvals: xTicks,
      ticktext: xTickLabels,
      tickfont: { color: "#E6EDF3", size: 12 },
      titlefont: { color: "#E6EDF3", size: 14 },
      showgrid: true,
      gridcolor: "rgba(140,140,140,0.22)"
    },

    yaxis: {
      type: "log",
      title: "Distanz [km]",
      tickvals: yTicks,
      ticktext: yTickLabels,
      tickfont: { color: "#E6EDF3", size: 12 },
      titlefont: { color: "#E6EDF3", size: 14 },
      showgrid: true,
      gridcolor: "rgba(140,140,140,0.22)"
    },

    hovermode: "closest"
  };

  Plotly.newPlot("percentilePlot", [trace], layout, {
    responsive: true,
    displayModeBar: false
  });
}
</script>
